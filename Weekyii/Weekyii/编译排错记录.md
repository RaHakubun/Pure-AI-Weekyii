# 编译排错记录（Weekyii iOS）

> 用于记录编译过程中出现的错误、原因与解决方式，作为后续开发警示。

## 1) Info.plist 重复输出
**报错**
- duplicate output file ... Info.plist

**原因**
- 工程同时启用了自动生成 Info.plist + 手动加入 `Resources/Info.plist`

**解决**
- 保留自动生成 Info.plist
- 移除 `Resources/Info.plist` 的 Target Membership

---

## 2) Localizable.xcstrings 缺少 version
**报错**
- Missing required key 'version'

**原因**
- xcstrings 文件缺少必需字段

**解决**
- 增加：`"version" : "1.0"`

---

## 3) XCTest 被加入主 Target
**报错**
- Unable to find module dependency: 'XCTest'

**原因**
- Tests 目录下的测试文件被编译进主 App Target

**解决**
- 将 `Tests/*.swift` 从 App Target 的 Sources 中移除

---

## 4) Combine 未导入
**报错**
- autoconnect() is not available due to missing import Combine

**原因**
- 使用 `Timer.publish(...).autoconnect()` 但未 import Combine

**解决**
- 在 `WeekyiiApp.swift` 增加 `import Combine`

---

## 5) SwiftData Predicate + enum case 报错
**报错**
- key path cannot refer to enum case 'present'

**原因**
- `#Predicate` 在该版本中不支持直接比较 enum case

**解决**
- 改为先 fetch 全部，再内存 filter
- 影响文件：
  - `Features/Week/WeekViewModel.swift`
  - `Features/Today/TodayViewModel.swift`
  - `Features/Pending/PendingViewModel.swift`
  - `Features/Past/PastViewModel.swift`
  - `Services/StateMachine.swift`

---

## 6) 缺少 AppIcon / AccentColor
**报错**
- None of the input catalogs contained a matching app icon set named "AppIcon"

**原因**
- Asset Catalog 中没有 AppIcon / AccentColor

**解决**
- 增加：
  - `Resources/Assets.xcassets/AppIcon.appiconset`
  - `Resources/Assets.xcassets/AccentColor.colorset`

---

## 7) Primary 颜色名冲突
**报错**
- "Primary" color asset name resolves to a conflicting Color symbol "primary"

**原因**
- 资源名与系统 `Color.primary` 冲突

**解决**
- 重命名为 `PrimaryBrand.colorset`
- `Color+Weekyii.swift` 改为 `Color("PrimaryBrand")`

---

## 8) MainActor 隔离警告
**报错**
- TimeProvider / NotificationService 作为默认参数在非主线程初始化

**原因**
- Swift 并发推断导致的 main actor 警告

**解决**
- 取消默认参数，改为显式注入
- 调用处明确传入 `TimeProvider()` / `.shared`

---

## 9) AppIcon iOS Marketing 警告
**报错**
- A 1024x1024 app store icon is required

**原因**
- `Contents.json` 中 1024 图标 idiom 写错

**解决**
- 将 1024 图标 entry 改为 `"idiom": "ios-marketing"`

---

## 结论
- 编译最终成功（iPhone 17 Pro / iOS 26.2）。
- 以上问题均已修复，可作为后续开发的排错手册。

---

## 2026-01-30 UI 重构编译排错记录

### 10) 重复的 Colors+Weekyii.swift 文件
**报错**
- Duplicate symbol 'weekyiiPrimary' in scope

**原因**
- 存在两个 `Colors+Weekyii.swift` 文件:
  - `/Shared/Extensions/Colors+Weekyii.swift` (旧文件)
  - `/Shared/DesignSystem/Colors+Weekyii.swift` (新文件)
- Xcode 项目同时引用了两个文件

**解决**
- 删除旧文件的物理文件
- 在 Xcode 项目中移除旧文件的引用
- 保留新的设计系统文件

**影响文件**
- `Shared/Extensions/Colors+Weekyii.swift` (已删除)

---

### 11) TaskCard 中 color 属性歧义
**报错**
- Ambiguous use of 'color'

**原因**
- `TaskType` extension 和 `TaskCard` 内部都定义了 `color` 属性
- 导致编译器无法确定使用哪个

**解决**
- 删除 `TaskCard.swift` 中重复的 `TaskType` extension
- 统一使用 `TaskType` 原有的 `color` 属性

**影响文件**
- `Shared/Components/TaskCard.swift`

---

### 12) StatusBadge 重复定义
**报错**
- Invalid redeclaration of 'StatusBadge'

**原因**
- `TaskCard.swift` 中定义了新的 `StatusBadge`
- 但项目中已存在 `StatusBadge` 组件

**解决**
- 将 `TaskCard.swift` 中的 `StatusBadge` 重命名为 `TaskZoneBadge`
- 创建独立的 `TaskZoneBadge.swift` 文件
- 更新所有引用

**影响文件**
- `Shared/Components/TaskCard.swift`
- `Shared/Components/TaskZoneBadge.swift` (新建)

---

### 13) DayStatus 缺少颜色定义
**报错**
- Type 'DayStatus' has no member 'color'

**原因**
- `StatusBadge` 使用了 `status.color`
- 但 `DayStatus` enum 没有定义 `color` 属性

**解决**
- 在 `DayStatus.swift` 中添加 `color` 计算属性
- 为每个状态定义对应的颜色

**影响文件**
- `Models/Enums/DayStatus.swift`

---

### 14) ScaleButtonStyle 重复定义
**报错**
- Invalid redeclaration of 'ScaleButtonStyle'

**原因**
- 创建了独立的 `ScaleButtonStyle.swift` 文件
- 但 `WeekButton.swift` 中已经定义了 `ScaleButtonStyle`

**解决**
- 删除重复的 `Shared/Styles/ScaleButtonStyle.swift` 文件
- 在 Xcode 项目中移除文件引用
- 使用 `WeekButton.swift` 中的定义

**影响文件**
- `Shared/Styles/ScaleButtonStyle.swift` (已删除)

---

### 15) WeekModel 初始化参数缺失
**报错**
- Missing arguments for parameters 'startDate', 'endDate' in call

**原因**
- Preview 代码中使用了简化的初始化
- 但 `WeekModel` 需要完整的参数

**解决**
- 在 Preview 中添加完整的初始化参数
- 使用 Calendar 计算日期

**影响文件**
- `Features/Week/WeekStatCard.swift`
- `Features/Week/DayCard.swift`

---

### 16) WeekStatus 没有 active 成员
**报错**
- Type 'WeekStatus' has no member 'active'

**原因**
- Preview 代码中使用了不存在的 `.active` 状态
- `WeekStatus` 只有 `pending` 和 `completed`

**解决**
- 将 Preview 中的 `.active` 改为 `.pending`

**影响文件**
- `Features/Week/WeekStatCard.swift`

---

### 17) DayModel 初始化参数缺失
**报错**
- Missing argument for parameter 'date' in call

**原因**
- Preview 代码中缺少 `date` 参数
- `DayModel` 需要 `date: Date` 参数

**解决**
- 在 Preview 中添加 `date` 参数
- 使用 Calendar 计算日期

**影响文件**
- `Features/Week/DayCard.swift`

---

### 18) WeekModel 没有 createdAt 属性
**报错**
- Value of type 'WeekModel' has no member 'createdAt'

**原因**
- `PendingWeekCard` 中尝试访问不存在的 `createdAt` 属性

**解决**
- 移除显示创建时间的代码
- 改为显示状态图标

**影响文件**
- `Features/Pending/PendingWeekCard.swift`

---

### 19) 新文件未添加到 Xcode 项目
**报错**
- Cannot find 'WeekStatCard' in scope
- Cannot find 'DayCard' in scope
- Cannot find 'PendingWeekCard' in scope

**原因**
- 新创建的文件只存在于文件系统
- 未添加到 Xcode 项目的编译目标

**解决**
- 在 Xcode 中使用 "Add Files to 'Weekyii'..." 添加文件
- 确保勾选 "Weekyii" target
- 取消勾选 "Copy items if needed" (文件已在正确位置)

**影响文件**
- `Features/Week/WeekStatCard.swift`
- `Features/Week/DayCard.swift`
- `Features/Pending/PendingWeekCard.swift`
- `Shared/Extensions/Animation+Weekyii.swift`
- `Shared/Components/LoadingView.swift`
- `Shared/Extensions/View+Transitions.swift`

---

### 20) ProgressBar 缺少 showPercentage 参数
**报错**
- Extra argument 'showPercentage' in call

**原因**
- 代码中使用了 `showPercentage` 参数
- 但 `ProgressBar` 组件可能不支持此参数

**解决**
- 检查 `ProgressBar` 组件定义
- 如果不支持则移除参数
- 或者添加参数支持

**影响文件**
- `Features/Past/PastView.swift`

---

### 21) Today 截止线遮挡滚动与交互
**现象**
- 「今日」页面无法上下滚动，冻结区/子板块无法滑动或点击

**原因**
- 截止线与启动块使用 `ZStack` 叠在 `ScrollView` 上层
- 线条覆盖区域命中手势并阻断了底层滚动
- `highPriorityGesture` 提升了拦截优先级

**解决**
- 移除截止线覆盖层（回退为普通 kill time 卡片）
- 或将线条移入 `safeAreaInset`，并将 hit-testing 限制在窄范围

**影响文件**
- `Features/Today/TodayView.swift`

---

## 本次重构编译总结

### 主要问题类型
1. **文件重复** - 旧文件未清理导致符号冲突
2. **组件重复定义** - 多处定义相同的组件或扩展
3. **属性缺失** - 使用了模型中不存在的属性
4. **初始化参数** - Preview 代码参数不完整
5. **文件引用** - 新文件未添加到 Xcode 项目

### 解决策略
1. **及时清理** - 删除旧文件和重复定义
2. **检查模型** - 使用前确认属性存在
3. **完整初始化** - Preview 使用完整参数
4. **手动添加** - 新文件需在 Xcode 中添加引用

### 编译结果
- ✅ **BUILD SUCCEEDED**
- ✅ 所有27个新文件编译通过
- ✅ 所有主视图和组件正常工作
- ✅ 动画系统正常运行

### 经验教训
1. 创建新文件前先检查是否已存在
2. 重构时及时删除旧文件避免冲突
3. Preview 代码要使用真实的初始化参数
4. 新文件创建后立即添加到 Xcode 项目
5. 每次重大改动后立即编译测试
